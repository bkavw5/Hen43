<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dora Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --secondary: #10b981;
      --secondary-hover: #059669;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --dark-bg: #111827;
      --card-bg: rgba(30, 32, 39, 0.8);
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --border-color: rgba(255, 255, 255, 0.1);
    }
    
    body {
      background: var(--dark-bg);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    
    .forum-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .forum-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .forum-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    .btn-primary {
      background: var(--primary);
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: var(--secondary);
      transition: all 0.2s ease;
    }
    
    .btn-success:hover {
      background: var(--secondary-hover);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      transition: all 0.2s ease;
    }
    
    .btn-danger:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }
    
    .input-field {
      background: rgba(17, 24, 39, 0.6);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    
    .sticky {
      border-left: 4px solid #facc15;
      background: rgba(250, 204, 21, 0.05);
    }
    
    .category-badge {
      background: rgba(79, 70, 229, 0.2);
      color: #818cf8;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .comment-count {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .admin-badge {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .pagination-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    
    .pagination-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .pagination-btn.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .navbar {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
    }
    
    .bbcode img {
      max-width: 100%;
      border-radius: 8px;
      margin: 8px 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    
    .bbcode iframe {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 8px;
      margin: 8px 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    
    .topic-content {
      border-left: 3px solid var(--primary);
      padding-left: 12px;
      margin: 12px 0;
    }
    
    .divider {
      height: 1px;
      background: var(--border-color);
      margin: 16px 0;
    }
  </style>
</head>
<body class="min-h-screen">

<div class="forum-container p-4">
  <!-- Header -->
  <header class="navbar rounded-lg p-4 mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i class="fas fa-comments text-indigo-400"></i>
      Dora Forum
    </h1>
    <div class="text-sm text-gray-400">
      <i class="fas fa-users mr-1"></i>
      <span id="onlineCount">12</span> người online
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <!-- Login -->
      <div class="mb-6 forum-card p-6 rounded-xl" id="loginForm">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-sign-in-alt text-indigo-400"></i>
          Đăng nhập
        </h2>
        <input class="input-field p-3 w-full mb-3 rounded-lg" id="loginName" placeholder="Tên đăng nhập" type="text" />
        <input class="input-field p-3 w-full mb-4 rounded-lg" id="loginPass" placeholder="Mật khẩu (nếu là Admin)" type="password" />
        <button class="btn-primary px-4 py-3 rounded-lg w-full font-medium" onclick="loginUser()">
          <i class="fas fa-sign-in-alt mr-2"></i>Đăng nhập
        </button>
      </div>

      <!-- User -->
      <div class="hidden mb-6 forum-card p-6 rounded-xl" id="userSection">
        <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
          <i class="fas fa-user-circle text-indigo-400"></i>
          Thông tin người dùng
        </h2>
        <p class="mb-4">Xin chào, <span class="font-bold text-indigo-300" id="currentUser"></span>!</p>
        <button class="btn-danger px-4 py-2 rounded-lg font-medium" onclick="logoutUser()">
          <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
        </button>
      </div>

      <!-- Post Topic -->
      <form class="hidden mb-6 forum-card p-6 rounded-xl" id="topicForm">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-pen text-indigo-400"></i>
          Tạo chủ đề mới
        </h2>
        <input class="input-field p-3 w-full mb-3 rounded-lg" id="title" placeholder="Tiêu đề" type="text" />
        <textarea class="input-field p-3 w-full mb-3 rounded-lg" id="content" placeholder="Nội dung (hỗ trợ BBCode)" rows="5"></textarea>
        <select class="input-field p-3 w-full mb-4 rounded-lg" id="category">
          <option>Chung</option>
          <option>Hỏi đáp</option>
          <option>Thảo luận</option>
        </select>
        <button class="btn-success px-4 py-3 rounded-lg w-full font-medium" type="submit">
          <i class="fas fa-paper-plane mr-2"></i>Đăng chủ đề
        </button>

        <!-- BBCode Hướng dẫn -->
        <div class="mt-6 p-4 bg-gray-800 rounded-lg">
          <h3 class="font-medium text-indigo-300 mb-2 flex items-center gap-2">
            <i class="fas fa-info-circle"></i>
            Hướng dẫn BBCode
          </h3>
          <ul class="text-sm text-gray-400 space-y-1">
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[b]chữ đậm[/b]</code> - <strong>chữ đậm</strong></li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[i]chữ nghiêng[/i]</code> - <em>chữ nghiêng</em></li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[url=link]tên[/url]</code> - <a href="#" class="text-blue-400">liên kết</a></li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[img]url-hình[/img]</code> - hình ảnh</li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[video]url-video[/video]</code> - video</li>
          </ul>
        </div>
      </form>

      <!-- Filter + Search -->
      <div class="mb-6 forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-filter text-indigo-400"></i>
          Bộ lọc và Tìm kiếm
        </h2>
        <div class="flex flex-col sm:flex-row gap-3">
          <select class="input-field p-3 rounded-lg flex-1" id="filterCategory" onchange="applyFilterAndRender(1)">
            <option>Tất cả</option>
            <option>Chung</option>
            <option>Hỏi đáp</option>
            <option>Thảo luận</option>
          </select>
          <div class="relative flex-1">
            <input class="input-field p-3 w-full rounded-lg pl-10" id="searchKeyword" oninput="applyFilterAndRender(1)" placeholder="Tìm kiếm..." type="text" />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
          </div>
        </div>
      </div>

      <!-- Topics -->
      <div id="topicsList"></div>
      <div class="mt-6 flex gap-2 flex-wrap justify-center" id="pagination"></div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Stats -->
      <div class="forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-chart-bar text-indigo-400"></i>
          Thống kê
        </h2>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">Chủ đề</span>
            <span class="font-medium" id="statsTopics">0</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">Bình luận</span>
            <span class="font-medium" id="statsComments">0</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">Thành viên</span>
            <span class="font-medium" id="statsUsers">0</span>
          </div>
        </div>
      </div>

      <!-- Categories -->
      <div class="forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-folder text-indigo-400"></i>
          Danh mục
        </h2>
        <div class="space-y-2">
          <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="setCategoryFilter('Chung')">
            <div class="flex items-center gap-2">
              <i class="fas fa-comment text-gray-400"></i>
              <span>Chung</span>
            </div>
            <span class="text-sm text-gray-400" id="catCountGeneral">0</span>
          </div>
          <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="setCategoryFilter('Hỏi đáp')">
            <div class="flex items-center gap-2">
              <i class="fas fa-question-circle text-gray-400"></i>
              <span>Hỏi đáp</span>
            </div>
            <span class="text-sm text-gray-400" id="catCountQnA">0</span>
          </div>
          <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="setCategoryFilter('Thảo luận')">
            <div class="flex items-center gap-2">
              <i class="fas fa-users text-gray-400"></i>
              <span>Thảo luận</span>
            </div>
            <span class="text-sm text-gray-400" id="catCountDiscussion">0</span>
          </div>
        </div>
      </div>

      <!-- Online Users -->
      <div class="forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-user-friends text-indigo-400"></i>
          Đang trực tuyến
        </h2>
        <div class="space-y-2" id="onlineUsers">
          <div class="flex items-center gap-2 p-2">
            <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Admin" class="w-6 h-6 rounded-full">
            <span class="text-sm">Admin</span>
            <span class="admin-badge text-xs ml-auto">Admin</span>
          </div>
          <div class="flex items-center gap-2 p-2">
            <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=User1" class="w-6 h-6 rounded-full">
            <span class="text-sm">User1</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD-RnaaiHIxM5mvH_sTW9Q0_b8WKj5NZ4A",
  authDomain: "hen43-forum.firebaseapp.com",
  databaseURL: "https://hen43-forum-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hen43-forum",
  storageBucket: "hen43-forum.appspot.com",
  messagingSenderId: "27862338182",
  appId: "1:27862338182:web:90edc0fe3d31fb0d3a5f07",
  measurementId: "G-TK1G8LYT0T"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
let currentUser = null, isAdmin = false;
const pageSize = 5; 
let topics = [];

// Cookie
function setCookie(n,v,d=7){let t=new Date();t.setTime(t.getTime()+d*24*60*60*1000);document.cookie=n+"="+v+";expires="+t.toUTCString()+";path=/";}
function getCookie(n){return document.cookie.split("; ").reduce((r,v)=>{const[k,val]=v.split("=");return k===n?val:r},"");}
function eraseCookie(n){document.cookie=n+"=; Max-Age=0; path=/";}

// Login
window.onload=()=>{
  let u=getCookie("dora_user"),a=getCookie("dora_admin");
  if(u){currentUser=u;isAdmin=a==="1";showUserSection();}
  listenTopics();
  updateStats();
};

function loginUser(){
  let name=document.getElementById("loginName").value.trim();
  let pass=document.getElementById("loginPass").value;
  if(!name) return alert("Nhập tên đăng nhập");
  if(name==="Admin"){ if(pass!=="Top123") return alert("Sai mật khẩu!"); isAdmin=true; setCookie("dora_admin","1"); }
  currentUser=name; setCookie("dora_user",currentUser); showUserSection();
}

function logoutUser(){
  currentUser=null;isAdmin=false;eraseCookie("dora_user");eraseCookie("dora_admin");
  document.getElementById("userSection").classList.add("hidden");
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("topicForm").classList.add("hidden");
}

function showUserSection(){
  document.getElementById("currentUser").innerText=currentUser;
  document.getElementById("userSection").classList.remove("hidden");
  document.getElementById("loginForm").classList.add("hidden");
  document.getElementById("topicForm").classList.remove("hidden");
}

// === BBCode Parser ===
function parseBBCode(text) {
  return (text||"")
    .replace(/\[b\](.*?)\[\/b\]/gi, '<strong>$1</strong>')
    .replace(/\[i\](.*?)\[\/i\]/gi, '<em>$1</em>')
    .replace(/\[u\](.*?)\[\/u\]/gi, '<u>$1</u>')
    .replace(/\[url=(.*?)\](.*?)\[\/url\]/gi,
      '<a href="$1" target="_blank" class="text-blue-400 underline">$2</a>')
    .replace(/\[img\](.*?)\[\/img\]/gi,
      '<img src="$1" onerror="this.style.display=\'none\'" class="max-w-full rounded shadow"/>')
    .replace(/\[video\](.*?)\[\/video\]/gi, (match, url) => {
      if (url.includes("youtube.com") || url.includes("youtu.be")) {
        let videoId = "";
        if (url.includes("youtu.be")) {
          videoId = url.split("youtu.be/")[1];
        } else {
          try {
            const params = new URL(url).searchParams;
            videoId = params.get("v");
          } catch(e) {}
        }
        return `<iframe class="w-full max-h-96 rounded" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
      }
      return `<video controls class="w-full max-h-96 rounded">
                <source src="${url}" type="video/mp4">
                Trình duyệt không hỗ trợ video.
              </video>`;
    })
    .replace(/\[embed\](.*?)\[\/embed\]/gi, (match, url) => {
      return `<iframe src="${url}" class="w-full rounded shadow max-h-[500px]" frameborder="0" allowfullscreen></iframe>`;
    });
}
  
// Post topic
document.getElementById("topicForm").addEventListener("submit", function(e){
  e.preventDefault();
  if(!currentUser) return alert("Bạn cần đăng nhập!");
  
  let title = document.getElementById("title").value.trim();
  let content = document.getElementById("content").value.trim();
  let category = document.getElementById("category").value;

  if(!title || !content) return alert("Vui lòng nhập đầy đủ tiêu đề và nội dung!");

  let now = Date.now();

  // Thêm thông báo đang xử lý
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = "<i class='fas fa-spinner fa-spin mr-2'></i>Đang đăng...";
  submitBtn.disabled = true;

  db.ref("topics").push({
    title, content, category,
    author: currentUser,
    ts: now,
    sticky: false,
    comments: {}
  })
  .then(() => {
    // Clear form thủ công thay vì reset()
    document.getElementById("title").value = "";
    document.getElementById("content").value = "";
    document.getElementById("category").selectedIndex = 0;
    
    // Hiển thị thông báo thành công
    showNotification("Đăng chủ đề thành công!", "success");
  })
  .catch(err => {
    console.error("Lỗi Firebase:", err);
    showNotification("Lỗi đăng topic: " + err.message, "error");
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
});

// Avatar
function avatarUrl(name){return `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(name)}`;}

// Real-time load topics
function listenTopics(){
  db.ref("topics").on("value",snap=>{
    topics=[]; let obj=snap.val()||{};
    topics=Object.entries(obj).map(([id,t])=>({id,...t}));
    applyFilterAndRender(1);
    updateStats();
  });
}

// Update stats
function updateStats() {
  document.getElementById("statsTopics").textContent = topics.length;
  
  let commentCount = 0;
  topics.forEach(topic => {
    if (topic.comments) {
      commentCount += Object.keys(topic.comments).length;
    }
  });
  document.getElementById("statsComments").textContent = commentCount;
  
  // Update category counts
  const catCounts = {
    'Chung': 0,
    'Hỏi đáp': 0,
    'Thảo luận': 0
  };
  
  topics.forEach(topic => {
    if (catCounts.hasOwnProperty(topic.category)) {
      catCounts[topic.category]++;
    }
  });
  
  document.getElementById("catCountGeneral").textContent = catCounts['Chung'];
  document.getElementById("catCountQnA").textContent = catCounts['Hỏi đáp'];
  document.getElementById("catCountDiscussion").textContent = catCounts['Thảo luận'];
}

// Filter + Render
function applyFilterAndRender(page){
  let cat=document.getElementById("filterCategory").value;
  let kw=document.getElementById("searchKeyword").value.trim().toLowerCase();
  let arr=topics;
  if(cat!=="Tất cả") arr=arr.filter(t=>t.category===cat);
  if(kw) arr=arr.filter(t=>(t.title||"").toLowerCase().includes(kw)||(t.content||"").toLowerCase().includes(kw));
  arr.sort((a,b)=> (b.sticky===true)-(a.sticky===true) || b.ts-a.ts);
  let total=arr.length,pages=Math.ceil(total/pageSize),start=(page-1)*pageSize;
  renderTopics(arr.slice(start,start+pageSize)); renderPagination(page,pages);
}

// Set category filter
function setCategoryFilter(category) {
  document.getElementById("filterCategory").value = category;
  applyFilterAndRender(1);
}

// Render topics
function renderTopics(arr){
  let cont=document.getElementById("topicsList");
  if (arr.length === 0) {
    cont.innerHTML = `
      <div class="forum-card p-6 rounded-xl text-center">
        <i class="fas fa-inbox text-4xl text-gray-600 mb-3"></i>
        <h3 class="text-lg font-medium text-gray-400">Không có chủ đề nào</h3>
        <p class="text-gray-500">Hãy là người đầu tiên tạo chủ đề!</p>
      </div>
    `;
    return;
  }
  
  cont.innerHTML=arr.map(t=>{
    let time=new Date(t.ts).toLocaleString("vi-VN");
    let cmCnt=t.comments?Object.keys(t.comments).length:0;
    let isAuthorAdmin=t.author==="Admin";
    return `
      <div class="forum-card p-6 rounded-xl mb-4 ${t.sticky?"sticky":""}">
        <div class="flex items-center mb-3">
          <img src="${avatarUrl(t.author)}" class="w-10 h-10 rounded-full mr-3">
          <div>
            <div class="flex items-center gap-2">
              <span class="font-medium">${t.author}</span>
              ${isAuthorAdmin?'<span class="admin-badge">Admin</span>':''}
            </div>
            <span class="text-sm text-gray-400">${time}</span>
          </div>
          <div class="ml-auto flex gap-2">
            <span class="category-badge">${t.category}</span>
            <span class="comment-count"><i class="fas fa-comment mr-1"></i>${cmCnt}</span>
          </div>
        </div>
        <h2 class="text-xl font-semibold mb-2">${t.title}</h2>
        <div class="topic-content bbcode text-gray-300">${parseBBCode(t.content)}</div>
        <div class="divider"></div>
        <div class="mt-2">${renderCommentSection(t)}</div>
        ${isAdmin?`
          <div class="mt-4 flex gap-2">
            <button onclick="deleteTopic('${t.id}')" class="btn-danger px-3 py-1 rounded text-sm">
              <i class="fas fa-trash mr-1"></i>Xóa
            </button>
            <button onclick="editTopicPrompt('${t.id}','${t.title}','${t.content}')" class="bg-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-500">
              <i class="fas fa-edit mr-1"></i>Sửa
            </button>
            <button onclick="toggleSticky('${t.id}',${t.sticky})" class="bg-yellow-600 px-3 py-1 rounded text-sm hover:bg-yellow-500">
              <i class="fas fa-thumbtack mr-1"></i>${t.sticky?"Bỏ ghim":"Ghim"}
            </button>
          </div>`:""}
      </div>`;}).join("");
}

// Render comments
function renderCommentSection(topic){
  return `<div class="mb-3">${topic.comments?Object.entries(topic.comments).map(([cid,cm])=>{
      let t=new Date(cm.ts).toLocaleString("vi-VN"); let isAdminComment=cm.user==="Admin";
      return `<div class="flex items-start mb-4">
        <img src="${avatarUrl(cm.user)}" class="w-8 h-8 rounded-full mr-3 mt-1">
        <div class="flex-1">
          <div class="flex justify-between items-center mb-1">
            <div class="flex items-center gap-2">
              <span class="font-medium ${isAdminComment?'text-yellow-400':''}">${cm.user}</span>
              ${isAdminComment?'<span class="admin-badge text-xs">Admin</span>':''}
            </div>
            <span class="text-xs text-gray-400">${t}</span>
          </div>
          <p class="bbcode text-gray-300">${parseBBCode(cm.text)}</p>
          ${isAdmin?`<button onclick="deleteComment('${topic.id}','${cid}')" class="mt-1 text-xs text-red-400 hover:underline">
            <i class="fas fa-trash mr-1"></i>Xóa
          </button>`:""}
        </div>
      </div>`;}).join(""):""}</div>
      ${currentUser?`
        <div class="mt-2 flex">
          <input id="cm-input-${topic.id}" type="text" placeholder="Viết bình luận..." class="input-field flex-1 p-2 rounded-l-lg">
          <button onclick="postComment('${topic.id}')" class="btn-primary px-4 rounded-r-lg">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>`:""}`;
}

function postComment(id){
  let inp=document.getElementById("cm-input-"+id); let text=inp.value.trim(); if(!text) return;
  db.ref("topics/"+id+"/comments").push({user:currentUser,text,ts:Date.now()})
    .then(()=>{inp.value=""; showNotification("Đăng bình luận thành công!", "success");})
    .catch(err=>showNotification("Lỗi đăng bình luận: "+err.message, "error"));
}

// Admin tools
function deleteTopic(id){if(confirm("Xóa chủ đề?")) db.ref("topics/"+id).remove().then(() => {
  showNotification("Đã xóa chủ đề", "success");
});}
function editTopicPrompt(id,title,content){let nt=prompt("Tiêu đề:",title); if(nt===null) return;
  let nc=prompt("Nội dung:",content); if(nc===null) return;
  db.ref("topics/"+id).update({title:nt,content:nc}).then(() => {
    showNotification("Đã cập nhật chủ đề", "success");
  });}
function toggleSticky(id,cur){db.ref("topics/"+id).update({sticky:!cur}).then(() => {
  showNotification(`Đã ${!cur ? 'ghim' : 'bỏ ghim'} chủ đề`, "success");
});}
function deleteComment(tid,cid){if(confirm("Xóa bình luận?")) db.ref("topics/"+tid+"/comments/"+cid).remove().then(() => {
  showNotification("Đã xóa bình luận", "success");
});}

// Pagination
function renderPagination(cur,max){
  let pg=document.getElementById("pagination"); pg.innerHTML="";
  if (max <= 1) return;
  
  // Previous button
  if (cur > 1) {
    let prevBtn=document.createElement("button");
    prevBtn.innerHTML = "<i class='fas fa-chevron-left'></i>";
    prevBtn.className = "pagination-btn w-10 h-10 rounded-lg flex items-center justify-center";
    prevBtn.onclick=()=>applyFilterAndRender(cur-1);
    pg.appendChild(prevBtn);
  }
  
  // Page numbers
  for(let i=1;i<=max;i++){
    let b=document.createElement("button");
    b.innerText=i; 
    b.className=`pagination-btn w-10 h-10 rounded-lg flex items-center justify-center ${i===cur?"active":""}`;
    b.onclick=()=>applyFilterAndRender(i); 
    pg.appendChild(b);
  }
  
  // Next button
  if (cur < max) {
    let nextBtn=document.createElement("button");
    nextBtn.innerHTML = "<i class='fas fa-chevron-right'></i>";
    nextBtn.className = "pagination-btn w-10 h-10 rounded-lg flex items-center justify-center";
    nextBtn.onclick=()=>applyFilterAndRender(cur+1);
    pg.appendChild(nextBtn);
  }
}

// Notification system
function showNotification(message, type = "info") {
  const notification = document.createElement("div");
  notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
    type === "success" ? "bg-green-600" : 
    type === "error" ? "bg-red-600" : "bg-blue-600"
  }`;
  notification.innerHTML = `
    <div class="flex items-center">
      <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-circle" : "info-circle"} mr-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    notification.style.opacity = "0";
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}
</script>

</body>
</html>
