<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hen43 Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --secondary: #10b981;
      --secondary-hover: #059669;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --dark-bg: #111827;
      --card-bg: rgba(30, 32, 39, 0.8);
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --border-color: rgba(255, 255, 255, 0.1);
    }
    
    body {
      background: var(--dark-bg);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    
    .forum-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .forum-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .forum-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    .btn-primary {
      background: var(--primary);
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: var(--secondary);
      transition: all 0.2s ease;
    }
    
    .btn-success:hover {
      background: var(--secondary-hover);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      transition: all 0.2s ease;
    }
    
    .btn-danger:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }
    
    .input-field {
      background: rgba(17, 24, 39, 0.6);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    
    .sticky {
      border-left: 4px solid #facc15;
      background: rgba(250, 204, 21, 0.05);
    }
    
    .category-badge {
      background: rgba(79, 70, 229, 0.2);
      color: #818cf8;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .comment-count {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .admin-badge {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .pagination-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    
    .pagination-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .pagination-btn.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .navbar {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
    }
    
    .bbcode img {
      max-width: 100%;
      border-radius: 8px;
      margin: 8px 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    
    .bbcode iframe {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 8px;
      margin: 8px 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    
    .topic-content {
      border-left: 3px solid var(--primary);
      padding-left: 12px;
      margin: 12px 0;
    }
    
    .divider {
      height: 1px;
      background: var(--border-color);
      margin: 16px 0;
    }
    
    @media (max-width: 768px) {
      .forum-container {
        padding: 1rem;
      }
      
      .grid-cols-1 {
        grid-template-columns: 1fr;
      }
      
      .lg\:col-span-2, .lg\:col-span-1 {
        grid-column: 1;
      }
      
      .flex-row {
        flex-direction: column;
      }
      
      .navbar {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }
      
      .forum-card {
        padding: 1rem;
      }
      
      .topic-content {
        padding-left: 8px;
      }
      
      .supercounter-container {
        display: flex;
        justify-content: center;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body class="min-h-screen">

<div class="forum-container p-4">
  <header class="navbar rounded-lg p-4 mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i class="fas fa-comments text-indigo-400"></i>
      Hen43 Forum
    </h1>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <!-- Auth Section -->
      <div class="mb-6 forum-card p-6 rounded-xl" id="authSection">
        <!-- Login Form -->
        <div id="loginForm">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <i class="fas fa-sign-in-alt text-indigo-400"></i>
            Đăng nhập
          </h2>
          <input class="input-field p-3 w-full mb-3 rounded-lg" id="loginUsername" placeholder="Tên đăng nhập" type="text" />
          <input class="input-field p-3 w-full mb-4 rounded-lg" id="loginPassword" placeholder="Mật khẩu" type="password" />
          <button class="btn-primary px-4 py-3 rounded-lg w-full font-medium mb-3" onclick="loginWithUsername()">
            <i class="fas fa-sign-in-alt mr-2"></i>Đăng nhập
          </button>
          <div class="text-center">
            <button class="text-indigo-400 hover:text-white text-sm" onclick="showRegisterForm()">Chưa có tài khoản? Đăng ký</button>
          </div>
        </div>

        <!-- Register Form -->
        <div class="hidden" id="registerForm">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <i class="fas fa-user-plus text-indigo-400"></i>
            Đăng ký
          </h2>
          <input class="input-field p-3 w-full mb-3 rounded-lg" id="registerUsername" placeholder="Tên đăng nhập" type="text" />
          <input class="input-field p-3 w-full mb-3 rounded-lg" id="registerPassword" placeholder="Mật khẩu" type="password" />
          <input class="input-field p-3 w-full mb-4 rounded-lg" id="registerDisplayName" placeholder="Tên hiển thị" type="text" />
          <button class="btn-success px-4 py-3 rounded-lg w-full font-medium mb-3" onclick="registerWithUsername()">
            <i class="fas fa-user-plus mr-2"></i>Đăng ký
          </button>
          <div class="text-center">
            <button class="text-indigo-400 hover:text-white text-sm" onclick="showLoginForm()">Đã có tài khoản? Đăng nhập</button>
          </div>
        </div>

        <!-- Forgot Password -->
        <div class="text-center mt-3">
          <button class="text-indigo-400 hover:text-white text-sm" onclick="showForgotPasswordForm()">Quên mật khẩu?</button>
        </div>

        <!-- Forgot Password Form -->
        <div class="hidden mt-4 p-4 bg-gray-800 rounded-lg" id="forgotPasswordForm">
          <h3 class="font-medium mb-3">Khôi phục mật khẩu</h3>
          <input class="input-field p-3 w-full mb-3 rounded-lg" id="forgotEmail" placeholder="Nhập email của bạn" type="email" />
          <button class="btn-primary px-4 py-2 rounded-lg w-full" onclick="resetPassword()">Gửi email khôi phục</button>
          <button class="text-indigo-400 hover:text-white text-sm mt-2" onclick="hideForgotPasswordForm()">Hủy</button>
        </div>
      </div>

      <!-- User Section -->
      <div class="hidden mb-6 forum-card p-6 rounded-xl" id="userSection">
        <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
          <i class="fas fa-user-circle text-indigo-400"></i>
          Chào mừng, <span class="font-bold text-indigo-300" id="currentUser"></span>!
        </h2>
        <p class="mb-4 text-sm text-gray-400">Email: <span id="userEmail"></span></p>
        <button class="btn-danger px-4 py-2 rounded-lg font-medium mr-2" onclick="logoutUser()">
          <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
        </button>
        <button class="btn-primary px-4 py-2 rounded-lg font-medium" onclick="updateProfile()">
          <i class="fas fa-edit mr-2"></i>Cập nhật hồ sơ
        </button>
      </div>

      <!-- Update Profile Form -->
      <div class="hidden mb-6 forum-card p-6 rounded-xl" id="updateProfileForm">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-edit text-indigo-400"></i>
          Cập nhật hồ sơ
        </h2>
        <input class="input-field p-3 w-full mb-3 rounded-lg" id="updateDisplayName" placeholder="Tên hiển thị mới" type="text" />
        <button class="btn-success px-4 py-3 rounded-lg w-full font-medium" onclick="saveProfileUpdate()">
          <i class="fas fa-save mr-2"></i>Lưu thay đổi
        </button>
        <button class="btn-danger px-4 py-3 rounded-lg w-full font-medium mt-2" onclick="cancelProfileUpdate()">
          <i class="fas fa-times mr-2"></i>Hủy
        </button>
      </div>

      <!-- Post Topic -->
      <form class="hidden mb-6 forum-card p-6 rounded-xl" id="topicForm">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-pen text-indigo-400"></i>
          Tạo chủ đề mới
        </h2>
        <input class="input-field p-3 w-full mb-3 rounded-lg" id="title" placeholder="Tiêu đề" type="text" />
        <textarea class="input-field p-3 w-full mb-3 rounded-lg" id="content" placeholder="Nội dung (hỗ trợ BBCode)" rows="5"></textarea>
        <select class="input-field p-3 w-full mb-4 rounded-lg" id="category">
          <option>Chung</option>
          <option>Hỏi đáp</option>
          <option>Thảo luận</option>
        </select>
        <button class="btn-success px-4 py-3 rounded-lg w-full font-medium" type="submit">
          <i class="fas fa-paper-plane mr-2"></i>Đăng chủ đề
        </button>

        <!-- BBCode Hướng dẫn -->
        <div class="mt-6 p-4 bg-gray-800 rounded-lg">
          <h3 class="font-medium text-indigo-300 mb-2 flex items-center gap-2">
            <i class="fas fa-info-circle"></i>
            Hướng dẫn BBCode
          </h3>
          <ul class="text-sm text-gray-400 space-y-1">
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[b]chữ đậm[/b]</code> - <strong>chữ đậm</strong></li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[i]chữ nghiêng[/i]</code> - <em>chữ nghiêng</em></li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[url=link]tên[/url]</code> - <a href="#" class="text-blue-400">liên kết</a></li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[img]url-hình[/img]</code> - hình ảnh</li>
            <li><code class="bg-gray-700 px-1 py-0.5 rounded">[video]url-video[/video]</code> - video</li>
          </ul>
        </div>
      </form>

      <!-- Filter + Search -->
      <div class="mb-6 forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-filter text-indigo-400"></i>
          Bộ lọc và Tìm kiếm
        </h2>
        <div class="flex flex-col sm:flex-row gap-3">
          <select class="input-field p-3 rounded-lg flex-1" id="filterCategory" onchange="applyFilterAndRender(1)">
            <option>Tất cả</option>
            <option>Chung</option>
            <option>Hỏi đáp</option>
            <option>Thảo luận</option>
          </select>
          <div class="relative flex-1">
            <input class="input-field p-3 w-full rounded-lg pl-10" id="searchKeyword" oninput="debounce(applyFilterAndRender, 300)(1)" placeholder="Tìm kiếm..." type="text" />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
          </div>
        </div>
      </div>

      <!-- Topics -->
      <div id="topicsList"></div>
      <div class="mt-6 flex gap-2 flex-wrap justify-center" id="pagination"></div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Stats -->
      <div class="forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-chart-bar text-indigo-400"></i>
          Thống kê
        </h2>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">Chủ đề</span>
            <span class="font-medium" id="statsTopics">0</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">Bình luận</span>
            <span class="font-medium" id="statsComments">0</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">Thành viên</span>
            <span class="font-medium" id="statsUsers">0</span>
          </div>
        </div>
      </div>

      <!-- Categories -->
      <div class="forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-folder text-indigo-400"></i>
          Danh mục
        </h2>
        <div class="space-y-2">
          <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="setCategoryFilter('Chung')">
            <div class="flex items-center gap-2">
              <i class="fas fa-comment text-gray-400"></i>
              <span>Chung</span>
            </div>
            <span class="text-sm text-gray-400" id="catCountGeneral">0</span>
          </div>
          <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="setCategoryFilter('Hỏi đáp')">
            <div class="flex items-center gap-2">
              <i class="fas fa-question-circle text-gray-400"></i>
              <span>Hỏi đáp</span>
            </div>
            <span class="text-sm text-gray-400" id="catCountQnA">0</span>
          </div>
          <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="setCategoryFilter('Thảo luận')">
            <div class="flex items-center gap-2">
              <i class="fas fa-users text-gray-400"></i>
              <span>Thảo luận</span>
            </div>
            <span class="text-sm text-gray-400" id="catCountDiscussion">0</span>
          </div>
        </div>
      </div>

      <!-- Online Counter -->
      <div class="forum-card p-6 rounded-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-globe text-indigo-400"></i>
          Thống kê truy cập
        </h2>
        <div class="supercounter-container text-center">
          <script type="text/javascript" src="//widget.supercounters.com/ssl/online_i.js"></script>
          <script type="text/javascript">sc_online_i(1721766,"ffffff","818cf8");</script>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyD-RnaaiHIxM5mvH_sTW9Q0_b8WKj5NZ4A",
  authDomain: "hen43-forum.firebaseapp.com",
  databaseURL: "https://hen43-forum-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hen43-forum",
  storageBucket: "hen43-forum.appspot.com",
  messagingSenderId: "27862338182",
  appId: "1:27862338182:web:90edc0fe3d31fb0d3a5f07",
  measurementId: "G-TK1G8LYT0T"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let isAdmin = false;
const pageSize = 5;
let topics = [];

// Auth state observer
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    loadUserProfile(user.uid);
    showUserSection();
  } else {
    currentUser = null;
    isAdmin = false;
    showAuthSection();
  }
  listenTopics();
  updateStats();
});

function loadUserProfile(uid) {
  db.ref(`users/${uid}`).once('value').then((snapshot) => {
    const profile = snapshot.val();
    if (profile) {
      isAdmin = profile.isAdmin || false;
      document.getElementById('currentUser').textContent = profile.username || 'User';
      document.getElementById('userEmail').textContent = profile.email || '';
      document.getElementById('updateDisplayName').value = profile.username || '';
    }
  }).catch((error) => {
    console.error('Load profile error:', error);
    showNotification('Lỗi tải hồ sơ', 'error');
  });
}

function showAuthSection() {
  document.getElementById('authSection').classList.remove('hidden');
  document.getElementById('userSection').classList.add('hidden');
  document.getElementById('topicForm').classList.add('hidden');
  document.getElementById('updateProfileForm').classList.add('hidden');
  showLoginForm();
}

function showUserSection() {
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('userSection').classList.remove('hidden');
  document.getElementById('topicForm').classList.remove('hidden');
}

function showLoginForm() {
  document.getElementById('loginForm').classList.remove('hidden');
  document.getElementById('registerForm').classList.add('hidden');
  document.getElementById('forgotPasswordForm').classList.add('hidden');
}

function showRegisterForm() {
  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('registerForm').classList.remove('hidden');
  document.getElementById('forgotPasswordForm').classList.add('hidden');
}

function showForgotPasswordForm() {
  document.getElementById('forgotPasswordForm').classList.remove('hidden');
}

function hideForgotPasswordForm() {
  document.getElementById('forgotPasswordForm').classList.add('hidden');
}

// Login with username
function loginWithUsername() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!username || !password) {
    return showNotification('Vui lòng nhập tên đăng nhập và mật khẩu', 'error');
  }

  // Find user by username
  db.ref('users').orderByChild('username').equalTo(username).once('value').then((snapshot) => {
    const users = snapshot.val();
    if (!users) {
      return showNotification('Tên đăng nhập không tồn tại', 'error');
    }

    const userId = Object.keys(users)[0];
    const userData = users[userId];

    // Sign in with email and password
    auth.signInWithEmailAndPassword(userData.email, password)
      .then(() => {
        showNotification('Đăng nhập thành công!', 'success');
      })
      .catch((error) => {
        console.error('Login error:', error);
        let message = 'Lỗi đăng nhập';
        switch (error.code) {
          case 'auth/wrong-password':
            message = 'Mật khẩu không đúng';
            break;
          case 'auth/invalid-email':
            message = 'Email không hợp lệ';
            break;
          default:
            message = error.message;
        }
        showNotification(message, 'error');
      });
  }).catch((error) => {
    console.error('Username lookup error:', error);
    showNotification('Lỗi kiểm tra tên đăng nhập', 'error');
  });
}

// Register with username
function registerWithUsername() {
  const username = document.getElementById('registerUsername').value.trim();
  const password = document.getElementById('registerPassword').value;
  const displayName = document.getElementById('registerDisplayName').value.trim();

  if (!username || !password || !displayName) {
    return showNotification('Vui lòng nhập đầy đủ thông tin', 'error');
  }

  if (password.length < 6) {
    return showNotification('Mật khẩu phải ít nhất 6 ký tự', 'error');
  }

  // Check if username exists
  db.ref('users').orderByChild('username').equalTo(username).once('value').then((snapshot) => {
    if (snapshot.exists()) {
      return showNotification('Tên đăng nhập đã tồn tại', 'error');
    }

    // Create email from username (e.g., username@hen43forum.com)
    const email = `${username}@hen43forum.com`;

    // Create user with Firebase Auth
    auth.createUserWithEmailAndPassword(email, password)
      .then((userCredential) => {
        const user = userCredential.user;
        // Save profile to database
        return db.ref(`users/${user.uid}`).set({
          username: username,
          displayName: displayName,
          email: email,
          isAdmin: false,
          createdAt: Date.now()
        });
      })
      .then(() => {
        showNotification('Đăng ký thành công!', 'success');
        showLoginForm();
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerDisplayName').value = '';
      })
      .catch((error) => {
        console.error('Register error:', error);
        let message = 'Lỗi đăng ký';
        switch (error.code) {
          case 'auth/email-already-in-use':
            message = 'Email đã được sử dụng';
            break;
          case 'auth/invalid-email':
            message = 'Email không hợp lệ';
            break;
          case 'auth/weak-password':
            message = 'Mật khẩu quá yếu';
            break;
          default:
            message = error.message;
        }
        showNotification(message, 'error');
      });
  });
}

function resetPassword() {
  const email = document.getElementById('forgotEmail').value.trim();
  if (!email) {
    return showNotification('Vui lòng nhập email', 'error');
  }

  auth.sendPasswordResetEmail(email)
    .then(() => {
      showNotification('Email khôi phục đã được gửi!', 'success');
      hideForgotPasswordForm();
      document.getElementById('forgotEmail').value = '';
    })
    .catch((error) => {
      console.error('Reset password error:', error);
      showNotification('Lỗi gửi email: ' + error.message, 'error');
    });
}

function logoutUser() {
  auth.signOut().then(() => {
    showNotification('Đăng xuất thành công', 'success');
  }).catch((error) => {
    console.error('Logout error:', error);
    showNotification('Lỗi đăng xuất', 'error');
  });
}

function updateProfile() {
  document.getElementById('userSection').classList.add('hidden');
  document.getElementById('updateProfileForm').classList.remove('hidden');
}

function cancelProfileUpdate() {
  document.getElementById('updateProfileForm').classList.add('hidden');
  document.getElementById('userSection').classList.remove('hidden');
}

function saveProfileUpdate() {
  const newDisplayName = document.getElementById('updateDisplayName').value.trim();
  if (!newDisplayName) {
    return showNotification('Vui lòng nhập tên hiển thị', 'error');
  }

  if (currentUser) {
    db.ref(`users/${currentUser.uid}`).update({
      displayName: newDisplayName
    }).then(() => {
      document.getElementById('currentUser').textContent = newDisplayName;
      showNotification('Cập nhật hồ sơ thành công', 'success');
      cancelProfileUpdate();
    }).catch((error) => {
      console.error('Update profile error:', error);
      showNotification('Lỗi cập nhật hồ sơ', 'error');
    });
  }
}

// BBCode Parser
function parseBBCode(text) {
  return (text || "")
    .replace(/\[b\](.*?)\[\/b\]/gi, '<strong>$1</strong>')
    .replace(/\[i\](.*?)\[\/i\]/gi, '<em>$1</em>')
    .replace(/\[u\](.*?)\[\/u\]/gi, '<u>$1</u>')
    .replace(/\[url=(.*?)\](.*?)\[\/url\]/gi,
      '<a href="$1" target="_blank" class="text-blue-400 underline">$2</a>')
    .replace(/\[img\](.*?)\[\/img\]/gi,
      '<img src="$1" onerror="this.style.display=\'none\'" class="max-w-full rounded shadow"/>')
    .replace(/\[video\](.*?)\[\/video\]/gi, (match, url) => {
      if (url.includes("youtube.com") || url.includes("youtu.be")) {
        let videoId = "";
        if (url.includes("youtu.be")) {
          videoId = url.split("youtu.be/")[1];
        } else {
          try {
            const params = new URL(url).searchParams;
            videoId = params.get("v");
          } catch (e) {}
        }
        return `<iframe class="w-full max-h-96 rounded" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
      }
      return `<video controls class="w-full max-h-96 rounded">
                <source src="${url}" type="video/mp4">
                Trình duyệt không hỗ trợ video.
              </video>`;
    })
    .replace(/\[embed\](.*?)\[\/embed\]/gi, (match, url) => {
      return `<iframe src="${url}" class="w-full rounded shadow max-h-[500px]" frameborder="0" allowfullscreen></iframe>`;
    });
}

// Post topic
document.getElementById("topicForm").addEventListener("submit", function(e) {
  e.preventDefault();
  if (!currentUser) return showNotification("Bạn cần đăng nhập!", 'error');
  
  let title = document.getElementById("title").value.trim();
  let content = document.getElementById("content").value.trim();
  let category = document.getElementById("category").value;

  if (!title || !content) return showNotification("Vui lòng nhập đầy đủ tiêu đề và nội dung!", 'error');

  let now = Date.now();

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = "<i class='fas fa-spinner fa-spin mr-2'></i>Đang đăng...";
  submitBtn.disabled = true;

  db.ref("topics").push({
    title, content, category,
    author: currentUser.displayName || currentUser.email,
    authorId: currentUser.uid,
    ts: now,
    sticky: false,
    comments: {}
  })
  .then(() => {
    document.getElementById("title").value = "";
    document.getElementById("content").value = "";
    document.getElementById("category").selectedIndex = 0;
    showNotification("Đăng chủ đề thành công!", "success");
  })
  .catch(err => {
    console.error("Lỗi Firebase:", err);
    showNotification("Lỗi đăng topic: " + err.message, "error");
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
});

// Avatar
function avatarUrl(name) {
  return `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(name)}`;
}

// Real-time load topics
function listenTopics() {
  db.ref("topics").on("value", snap => {
    topics = [];
    let obj = snap.val() || {};
    topics = Object.entries(obj).map(([id, t]) => ({id, ...t}));
    applyFilterAndRender(1);
    updateStats();
  });
}

// Update stats
function updateStats() {
  document.getElementById("statsTopics").textContent = topics.length;
  
  let commentCount = 0;
  let users = new Set();
  
  topics.forEach(topic => {
    users.add(topic.author);
    if (topic.comments) {
      commentCount += Object.keys(topic.comments).length;
      Object.values(topic.comments).forEach(comment => {
        users.add(comment.user);
      });
    }
  });
  
  document.getElementById("statsComments").textContent = commentCount;
  document.getElementById("statsUsers").textContent = users.size;
  
  const catCounts = {
    'Chung': 0,
    'Hỏi đáp': 0,
    'Thảo luận': 0
  };
  
  topics.forEach(topic => {
    if (catCounts.hasOwnProperty(topic.category)) {
      catCounts[topic.category]++;
    }
  });
  
  document.getElementById("catCountGeneral").textContent = catCounts['Chung'];
  document.getElementById("catCountQnA").textContent = catCounts['Hỏi đáp'];
  document.getElementById("catCountDiscussion").textContent = catCounts['Thảo luận'];
}

// Filter + Render
function applyFilterAndRender(page) {
  let cat = document.getElementById("filterCategory").value;
  let kw = document.getElementById("searchKeyword").value.trim().toLowerCase();
  let arr = topics;
  if (cat !== "Tất cả") arr = arr.filter(t => t.category === cat);
  if (kw) arr = arr.filter(t => (t.title || "").toLowerCase().includes(kw) || (t.content || "").toLowerCase().includes(kw));
  arr.sort((a, b) => (b.sticky === true) - (a.sticky === true) || b.ts - a.ts);
  let total = arr.length, pages = Math.ceil(total / pageSize), start = (page - 1) * pageSize;
  renderTopics(arr.slice(start, start + pageSize)); 
  renderPagination(page, pages);
}

// Set category filter
function setCategoryFilter(category) {
  document.getElementById("filterCategory").value = category;
  applyFilterAndRender(1);
}

// Render topics
function renderTopics(arr) {
  let cont = document.getElementById("topicsList");
  if (arr.length === 0) {
    cont.innerHTML = `
      <div class="forum-card p-6 rounded-xl text-center">
        <i class="fas fa-inbox text-4xl text-gray-600 mb-3"></i>
        <h3 class="text-lg font-medium text-gray-400">Không có chủ đề nào</h3>
        <p class="text-gray-500">Hãy là người đầu tiên tạo chủ đề!</p>
      </div>
    `;
    return;
  }
  
  cont.innerHTML = arr.map(t => {
    let time = new Date(t.ts).toLocaleString("vi-VN");
    let cmCnt = t.comments ? Object.keys(t.comments).length : 0;
    let canEdit = currentUser && (isAdmin || t.authorId === currentUser.uid);
    return `
      <div class="forum-card p-6 rounded-xl mb-4 ${t.sticky ? "sticky" : ""}">
        <div class="flex items-center mb-3">
          <img src="${avatarUrl(t.author)}" class="w-10 h-10 rounded-full mr-3">
          <div>
            <div class="flex items-center gap-2">
              <span class="font-medium">${t.author}</span>
              <span class="admin-badge hidden" id="admin-badge-${t.id}"></span>
            </div>
            <span class="text-sm text-gray-400">${time}</span>
          </div>
          <div class="ml-auto flex gap-2">
            <span class="category-badge">${t.category}</span>
            <span class="comment-count"><i class="fas fa-comment mr-1"></i>${cmCnt}</span>
          </div>
        </div>
        <h2 class="text-xl font-semibold mb-2">${t.title}</h2>
        <div class="topic-content bbcode text-gray-300">${parseBBCode(t.content)}</div>
        <div class="divider"></div>
        <div class="mt-2">${renderCommentSection(t)}</div>
        ${canEdit ? `
          <div class="mt-4 flex gap-2">
            <button onclick="deleteTopic('${t.id}')" class="btn-danger px-3 py-1 rounded text-sm">
              <i class="fas fa-trash mr-1"></i>Xóa
            </button>
            <button onclick="editTopicPrompt('${t.id}','${t.title.replace(/'/g, "\\'")}','${t.content.replace(/'/g, "\\'")}')" class="bg-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-500">
              <i class="fas fa-edit mr-1"></i>Sửa
            </button>
            ${isAdmin ? `
            <button onclick="toggleSticky('${t.id}',${t.sticky})" class="bg-yellow-600 px-3 py-1 rounded text-sm hover:bg-yellow-500">
              <i class="fas fa-thumbtack mr-1"></i>${t.sticky ? "Bỏ ghim" : "Ghim"}
            </button>` : ''}
          </div>` : ""}
      </div>`;
  }).join("");

  // Check admin badges
  arr.forEach(t => {
    if (t.authorId) {
      db.ref(`users/${t.authorId}`).once('value').then(snapshot => {
        const profile = snapshot.val();
        if (profile && profile.isAdmin) {
          const badge = document.getElementById(`admin-badge-${t.id}`);
          if (badge) {
            badge.textContent = 'Admin';
            badge.classList.remove('hidden');
          }
        }
      });
    }
  });
}

// Render comments
function renderCommentSection(topic) {
  return `<div class="mb-3">${topic.comments ? Object.entries(topic.comments).map(([cid, cm]) => {
    let t = new Date(cm.ts).toLocaleString("vi-VN");
    let canEditComment = currentUser && (isAdmin || cm.userId === currentUser.uid);
    return `<div class="flex items-start mb-4">
      <img src="${avatarUrl(cm.user)}" class="w-8 h-8 rounded-full mr-3 mt-1">
      <div class="flex-1">
        <div class="flex justify-between items-center mb-1">
          <div class="flex items-center gap-2">
            <span class="font-medium">${cm.user}</span>
            <span class="admin-badge text-xs hidden" id="comment-admin-${topic.id}-${cid}"></span>
          </div>
          <span class="text-xs text-gray-400">${t}</span>
        </div>
        <p class="bbcode text-gray-300">${parseBBCode(cm.text)}</p>
        ${canEditComment ? `
          <div class="mt-1 flex gap-2">
            <button onclick="deleteComment('${topic.id}','${cid}')" class="text-xs text-red-400 hover:underline">
              <i class="fas fa-trash mr-1"></i>Xóa
            </button>
            <button onclick="editCommentPrompt('${topic.id}','${cid}','${cm.text.replace(/'/g, "\\'")}')" class="text-xs text-blue-400 hover:underline">
              <i class="fas fa-edit mr-1"></i>Sửa
            </button>
          </div>` : ""}
      </div>
    </div>`;
  }).join("") : ""}</div>
    ${currentUser ? `
      <div class="mt-2 flex">
        <input id="cm-input-${topic.id}" type="text" placeholder="Viết bình luận..." class="input-field flex-1 p-2 rounded-l-lg">
        <button onclick="postComment('${topic.id}')" class="btn-primary px-4 rounded-r-lg">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>` : ""}`;
}

// Post comment
function postComment(id) {
  let inp = document.getElementById("cm-input-" + id);
  let text = inp.value.trim();
  if (!text || !currentUser) return;

  db.ref("topics/" + id + "/comments").push({
    user: currentUser.displayName || currentUser.email,
    userId: currentUser.uid,
    text,
    ts: Date.now()
  })
    .then(() => {
      inp.value = "";
      showNotification("Đăng bình luận thành công!", "success");
    })
    .catch(err => showNotification("Lỗi đăng bình luận: " + err.message, "error"));
}

// Topic and Comment Management
function deleteTopic(id) {
  if (!currentUser) return;
  if (confirm("Xóa chủ đề?")) {
    db.ref("topics/" + id).remove().then(() => {
      showNotification("Đã xóa chủ đề", "success");
    }).catch(err => {
      showNotification("Lỗi xóa chủ đề: " + err.message, "error");
    });
  }
}

function editTopicPrompt(id, title, content) {
  if (!currentUser) return;
  let nt = prompt("Tiêu đề:", title);
  if (nt === null) return;
  let nc = prompt("Nội dung:", content);
  if (nc === null) return;

  db.ref("topics/" + id).update({title: nt, content: nc}).then(() => {
    showNotification("Đã cập nhật chủ đề", "success");
  }).catch(err => {
    showNotification("Lỗi cập nhật chủ đề: " + err.message, "error");
  });
}

function toggleSticky(id, cur) {
  if (!isAdmin) return;
  db.ref("topics/" + id).update({sticky: !cur}).then(() => {
    showNotification(`Đã ${!cur ? 'ghim' : 'bỏ ghim'} chủ đề`, "success");
  }).catch(err => {
    showNotification("Lỗi ghim chủ đề: " + err.message, "error");
  });
}

function deleteComment(tid, cid) {
  if (!currentUser) return;
  if (confirm("Xóa bình luận?")) {
    db.ref("topics/" + tid + "/comments/" + cid).remove().then(() => {
      showNotification("Đã xóa bình luận", "success");
    }).catch(err => {
      showNotification("Lỗi xóa bình luận: " + err.message, "error");
    });
  }
}

function editCommentPrompt(tid, cid, text) {
  if (!currentUser) return;
  let newText = prompt("Chỉnh sửa bình luận:", text);
  if (newText === null) return;

  db.ref(`topics/${tid}/comments/${cid}`).update({text: newText, ts: Date.now()}).then(() => {
    showNotification("Đã cập nhật bình luận", "success");
  }).catch(err => {
    showNotification("Lỗi cập nhật bình luận: " + err.message, "error");
  });
}

// Pagination
function renderPagination(cur, max) {
  let pg = document.getElementById("pagination");
  pg.innerHTML = "";
  if (max <= 1) return;

  if (cur > 1) {
    let prevBtn = document.createElement("button");
    prevBtn.innerHTML = "<i class='fas fa-chevron-left'></i>";
    prevBtn.className = "pagination-btn w-10 h-10 rounded-lg flex items-center justify-center";
    prevBtn.onclick = () => applyFilterAndRender(cur - 1);
    pg.appendChild(prevBtn);
  }

  for (let i = 1; i <= max; i++) {
    let b = document.createElement("button");
    b.innerText = i;
    b.className = `pagination-btn w-10 h-10 rounded-lg flex items-center justify-center ${i === cur ? "active" : ""}`;
    b.onclick = () => applyFilterAndRender(i);
    pg.appendChild(b);
  }

  if (cur < max) {
    let nextBtn = document.createElement("button");
    nextBtn.innerHTML = "<i class='fas fa-chevron-right'></i>";
    nextBtn.className = "pagination-btn w-10 h-10 rounded-lg flex items-center justify-center";
    nextBtn.onclick = () => applyFilterAndRender(cur + 1);
    pg.appendChild(nextBtn);
  }
}

// Notification system
function showNotification(message, type = "info") {
  const notification = document.createElement("div");
  notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
    type === "success" ? "bg-green-600" :
    type === "error" ? "bg-red-600" : "bg-blue-600"
  }`;
  notification.innerHTML = `
    <div class="flex items-center">
      <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-circle" : "info-circle"} mr-2"></i>
      <span>${message}</span>
    </div>
  `;

  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.opacity = "0";
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Debounce function for optimization
function debounce(func, delay) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), delay);
  };
}
</script>
</body>
</html>
